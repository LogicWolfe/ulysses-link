name: Publish to crates.io

on:
  push:
    branches: [main]

jobs:
  lint:
    runs-on: ubuntu-latest
    container: rust:latest
    steps:
      - uses: actions/checkout@v4
      - run: rustup component add clippy
      - run: cargo clippy --locked -- -D warnings

  test:
    runs-on: ubuntu-latest
    container: rust:latest
    steps:
      - uses: actions/checkout@v4
      - run: cargo test --locked

  publish:
    needs: [lint, test]
    runs-on: ubuntu-latest
    container: rust:latest
    steps:
      - uses: actions/checkout@v4

      - name: Check version against crates.io
        id: version
        run: |
          CURRENT=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')
          PUBLISHED=$(curl -sf https://crates.io/api/v1/crates/ulysses-link | sed -n 's/.*"max_version":"\([^"]*\)".*/\1/p')

          if [ -z "$PUBLISHED" ]; then
            PUBLISHED="0.0.0"
          fi

          LOWEST=$(printf '%s\n' "$PUBLISHED" "$CURRENT" | sort -V | head -1)
          if [ "$LOWEST" = "$PUBLISHED" ] && [ "$PUBLISHED" != "$CURRENT" ]; then
            echo "should_publish=true" >> "$GITHUB_OUTPUT"
            echo "New version: $CURRENT (published: $PUBLISHED)"
          else
            echo "should_publish=false" >> "$GITHUB_OUTPUT"
            echo "No publish needed: $CURRENT (published: $PUBLISHED)"
          fi
          echo "current=$CURRENT" >> "$GITHUB_OUTPUT"

      - name: Publish to crates.io
        if: steps.version.outputs.should_publish == 'true'
        run: cargo publish
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

      - name: Create git tag
        if: steps.version.outputs.should_publish == 'true'
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          TAG="v${{ steps.version.outputs.current }}"
          git tag "$TAG"
          git push origin "$TAG"
